---
title: "Authentication Injection with CoCart"
sidebarTitle: "Authentication Injection"
description: "Learn how to intervene CoCart's authentication"
icon: "syringe"
---

<Note>
    This guide only works if you have CoCart v4.8 and up installed.
</Note>

## What is authentication injection?

Authentication injection refers to the ability to insert custom authentication logic into the existing login process. This allows developers to implement additional security measures, such as two-factor authentication (2FA), custom validation rules, or logging mechanisms, without modifying the core authentication flow.

## Overview

CoCart's authentication injection system is built around a series of hooks (filters and actions) that allow you to customize the login process.

These hooks provide entry points to modify the behavior of authentication, enabling you to add layers of security or integrate with external systems.

## Available Hooks

Each hook is documented below with its description, parameters, and practical usage examples.

### `cocart_login_permission_callback`

<Info>
    Made available since v4.8.0
</Info>

Allows you to modify the permission result after basic authentication. This is the primary hook for adding additional authentication layers like 2FA.

<CodeGroup>

```php Basic Implementation
add_filter( 'cocart_login_permission_callback', function( $permission, $current_user, $request, $endpoint ) {
    // Your additional authentication logic here
    return $permission; // or return WP_Error to deny access
}, 10, 4 );
```

```php Advanced Example
add_filter( 'cocart_login_permission_callback', 'my_advanced_auth_check', 10, 4 );
function my_advanced_auth_check( $permission, $current_user, $request, $endpoint ) {
    if ( true !== $permission ) {
        return $permission;
    }

    // Example: Check user capabilities
    if ( ! user_can( $current_user, 'access_api' ) ) {
        return new WP_Error(
            'cocart_insufficient_permissions',
            'User lacks required permissions for API access',
            array( 'status' => 403 )
        );
    }

    return $permission;
}
```

</CodeGroup>

<ParamField query="permission" type="boolean|WP_Error">
  Current permission status (true after basic auth)
</ParamField>

<ParamField query="current_user" type="WP_User">
  The authenticated user object
</ParamField>

<ParamField query="request" type="WP_REST_Request">
  The current REST API request
</ParamField>

<ParamField query="endpoint" type="string">
  The endpoint being accessed ('login')
</ParamField>

<ResponseField name="Return Values" type="boolean|WP_Error">
  <Expandable title="Return Options">
    <ResponseField name="true" type="boolean">
      Allow login to proceed
    </ResponseField>
    <ResponseField name="WP_Error" type="object">
      Deny login with specific error message and data
    </ResponseField>
  </Expandable>
</ResponseField>

### `cocart_login_permission_granted`

<Info>
    Made available since v4.8.0
</Info>

Fires when login permission is successfully granted. Perfect for audit logging and post-authentication tasks.

<CodeGroup>

```php Basic Logging
add_action( 'cocart_login_permission_granted', function( $current_user, $request, $endpoint ) {
    // Log successful authentication
    error_log("Login granted for user: {$current_user->ID}");
}, 10, 3 );
```

```php Advanced Audit Logging
add_action( 'cocart_login_permission_granted', 'comprehensive_audit_log', 10, 3 );
function comprehensive_audit_log( $current_user, $request, $endpoint ) {
    $ip_address = CoCart_Authentication::get_ip_address();
    $user_agent = $request->get_header( 'user_agent' );

    // Log to custom table or external service
    wp_insert_post( array(
        'post_type' => 'auth_log',
        'post_status' => 'private',
        'post_title' => "Login: {$current_user->user_login}",
        'meta_input' => array(
            'user_id' => $current_user->ID,
            'ip_address' => $ip_address,
            'user_agent' => $user_agent,
            'endpoint' => $endpoint,
            'timestamp' => current_time( 'mysql' )
        )
    ) );
}
```

</CodeGroup>

<ParamField query="current_user" type="WP_User">
  The authenticated user object
</ParamField>

<ParamField query="request" type="WP_REST_Request">
  The current REST API request
</ParamField>

<ParamField query="endpoint" type="string">
  The endpoint being accessed ('login')
</ParamField>

### `cocart_login_secure_auth_methods`

<Info>
    Made available since v4.8.0
</Info>

Allows customizing which authentication methods skip additional checks (like 2FA).

<CodeGroup>

```php Add Custom Method
add_filter( 'cocart_login_secure_auth_methods', function( $secure_methods, $current_method ) {
    // Add custom secure authentication methods
    $secure_methods[] = 'custom_oauth';
    return $secure_methods;
}, 10, 2 );
```

```php Remove JWT Security
add_filter( 'cocart_login_secure_auth_methods', function( $secure_methods, $current_method ) {
    // Force 2FA even with JWT tokens
    $secure_methods = array_diff( $secure_methods, array( 'jwt' ) );
    return $secure_methods;
}, 10, 2 );
```

</CodeGroup>

<ParamField query="secure_methods" type="array">
  Array of authentication methods considered secure (default: ['jwt', 'api_key'])
</ParamField>

<ParamField query="current_method" type="string">
  The current authentication method being used
</ParamField>

### `cocart_login_collection_params`

<Info>
    Made available since v4.8.0
</Info>

Allows you to add additional parameters to the login endpoint for custom authentication data.

<CodeGroup>

```php Add 2FA Parameters
add_filter( 'cocart_login_collection_params', function( $additional_params ) {
    $additional_params['2fa_code'] = array(
        'description' => '2FA verification code',
        'type' => 'string',
        'required' => false,
        'sanitize_callback' => 'sanitize_text_field',
    );

    $additional_params['2fa_provider'] = array(
        'description' => '2FA provider type',
        'type' => 'string',
        'enum' => array( 'totp', 'sms', 'email' ),
    );

    return $additional_params;
} );
```

```php Add Custom Auth Fields
add_filter( 'cocart_login_collection_params', function( $additional_params ) {
    $additional_params['device_id'] = array(
        'description' => 'Unique device identifier',
        'type' => 'string',
        'required' => false,
    );

    $additional_params['app_version'] = array(
        'description' => 'Application version',
        'type' => 'string',
        'pattern' => '^[0-9]+\.[0-9]+\.[0-9]+$',
    );

    return $additional_params;
} );
```

</CodeGroup>

<ParamField query="additional_params" type="array">
  Array of additional parameters to add to the login endpoint
</ParamField>

## Implementation Examples

<Card title="Two-Factor Authentication (2FA)" icon="shield-check">
  A complete implementation showing how to add 2FA security to your CoCart authentication process.
</Card>

### Two-Factor Authentication (2FA) Implementation

<Steps>
  <Step title="Add 2FA Parameters">
    First, register the required parameters for 2FA authentication
  </Step>
  <Step title="Implement Permission Callback">
    Add the main authentication logic that checks for 2FA codes
  </Step>
  <Step title="Add Success Logging">
    Log successful authentications for audit purposes
  </Step>
</Steps>

Here's a complete example showing how to implement 2FA using the new authentication hooks:

```php
// Add 2FA parameter to login endpoint
add_filter( 'cocart_login_collection_params', 'add_2fa_params' );
function add_2fa_params( $additional_params ) {
    $additional_params['2fa_code'] = array(
        'description' => '2FA verification code',
        'type' => 'string',
        'required' => false,
        'sanitize_callback' => 'sanitize_text_field',
    );

    $additional_params['2fa_provider'] = array(
        'description' => '2FA provider type',
        'type' => 'string',
        'required' => false,
        'enum' => array( 'totp', 'sms', 'email' ),
    );

    return $additional_params;
}

// Implement 2FA check
add_filter( 'cocart_login_permission_callback', 'my_2fa_check', 10, 4 );
function my_2fa_check( $permission, $current_user, $request, $endpoint ) {
    // Only proceed if basic permission was granted
    if ( true !== $permission ) {
        return $permission;
    }

    // Check if user has 2FA enabled
    if ( get_user_meta( $current_user->ID, 'has_2fa_enabled', true ) ) {
        $two_factor_code = $request->get_param( '2fa_code' );
        $provider = $request->get_param( '2fa_provider' ) ?: 'totp';

        if ( empty( $two_factor_code ) ) {
            return new WP_Error(
                'cocart_2fa_required',
                '2FA verification required',
                array(
                    'status' => 400,
                    '2fa_required' => true,
                    'available_providers' => array( 'totp', 'sms', 'email' ),
                    'default_provider' => 'totp'
                )
            );
        }

        // Validate 2FA code based on provider
        if ( ! validate_2fa_code( $current_user->ID, $two_factor_code, $provider ) ) {
            return new WP_Error(
                'cocart_2fa_invalid',
                'Invalid 2FA code',
                array( 'status' => 401 )
            );
        }
    }

    return true; // Allow login
}

// Log successful authentications
add_action( 'cocart_login_permission_granted', 'log_successful_login', 10, 3 );
function log_successful_login( $current_user, $request, $endpoint ) {
    $ip_address = CoCart_Authentication::get_ip_address();
    error_log("CoCart login successful - User: {$current_user->ID}, IP: {$ip_address}");
}
```

## API Usage Examples

<Tabs>
  <Tab title="cURL">
    <Accordion title="Standard Login">
      ```bash
      curl -X POST "https://yoursite.com/wp-json/cocart/v2/login" \
        -H "Authorization: Basic $(echo -n 'username:password' | base64)" \
        -H "Content-Type: application/json"
      ```
    </Accordion>

    <Accordion title="Login with 2FA">
      ```bash
      curl -X POST "https://yoursite.com/wp-json/cocart/v2/login" \
        -H "Authorization: Basic $(echo -n 'username:password' | base64)" \
        -H "Content-Type: application/json" \
        -d '{
          "2fa_code": "123456",
          "2fa_provider": "totp"
        }'
      ```
    </Accordion>

    <Accordion title="Using JWT Token (bypasses 2FA)">
      ```bash
      curl -X POST "https://yoursite.com/wp-json/cocart/v2/login" \
        -H "Authorization: Bearer your-jwt-token-here" \
        -H "Content-Type: application/json"
      ```
    </Accordion>
  </Tab>

  <Tab title="PHP">
    <Accordion title="Standard Login Request">
      ```php
      $credentials = base64_encode('username:password');

      $response = wp_remote_post( 'https://yoursite.com/wp-json/cocart/v2/login', array(
          'headers' => array(
              'Authorization' => 'Basic ' . $credentials,
              'Content-Type' => 'application/json',
          ),
          'timeout' => 30,
      ) );

      if ( is_wp_error( $response ) ) {
          // Handle error
          echo 'Error: ' . $response->get_error_message();
      } else {
          $body = wp_remote_retrieve_body( $response );
          $data = json_decode( $body, true );

          if ( isset( $data['jwt_token'] ) ) {
              // Store JWT token for future requests
              $jwt_token = $data['jwt_token'];
          }
      }
      ```
    </Accordion>

    <Accordion title="Login with 2FA">
      ```php
      $credentials = base64_encode('username:password');

      $response = wp_remote_post( 'https://yoursite.com/wp-json/cocart/v2/login', array(
          'headers' => array(
              'Authorization' => 'Basic ' . $credentials,
              'Content-Type' => 'application/json',
          ),
          'body' => json_encode( array(
              '2fa_code' => '123456',
              '2fa_provider' => 'totp',
          ) ),
          'timeout' => 30,
      ) );

      $body = wp_remote_retrieve_body( $response );
      $data = json_decode( $body, true );

      if ( isset( $data['code'] ) && $data['code'] === 'cocart_2fa_required' ) {
          // Handle 2FA requirement
          echo 'Please provide 2FA code';
      } elseif ( isset( $data['jwt_token'] ) ) {
          // Login successful
          $jwt_token = $data['jwt_token'];
      }
      ```
    </Accordion>
  </Tab>

  <Tab title="JavaScript">
    <Accordion title="Standard Login with Fetch API">
      ```javascript
      const credentials = btoa('username:password');

      fetch('https://yoursite.com/wp-json/cocart/v2/login', {
          method: 'POST',
          headers: {
              'Authorization': `Basic ${credentials}`,
              'Content-Type': 'application/json',
          },
      })
      .then(response => response.json())
      .then(data => {
          if (data.jwt_token) {
              // Store JWT token
              localStorage.setItem('cocart_token', data.jwt_token);
              console.log('Login successful');
          } else if (data.code === 'cocart_2fa_required') {
              // Handle 2FA requirement
              handle2FARequired(data);
          }
      })
      .catch(error => {
          console.error('Login error:', error);
      });
      ```
    </Accordion>

    <Accordion title="Login with 2FA">
      ```javascript
      const credentials = btoa('username:password');

      fetch('https://yoursite.com/wp-json/cocart/v2/login', {
          method: 'POST',
          headers: {
              'Authorization': `Basic ${credentials}`,
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({
              '2fa_code': '123456',
              '2fa_provider': 'totp'
          })
      })
      .then(response => response.json())
      .then(data => {
          if (data.jwt_token) {
              localStorage.setItem('cocart_token', data.jwt_token);
              console.log('2FA login successful');
          } else if (data.code === 'cocart_2fa_invalid') {
              console.error('Invalid 2FA code');
          }
      })
      .catch(error => {
          console.error('2FA login error:', error);
      });
      ```
    </Accordion>

    <Accordion title="Using Stored JWT Token">
      ```javascript
      const jwtToken = localStorage.getItem('cocart_token');

      fetch('https://yoursite.com/wp-json/cocart/v2/login', {
          method: 'POST',
          headers: {
              'Authorization': `Bearer ${jwtToken}`,
              'Content-Type': 'application/json',
          },
      })
      .then(response => response.json())
      .then(data => {
          if (data.jwt_token) {
              // Token is valid, login successful
              console.log('JWT login successful');
          }
      })
      .catch(error => {
          // Token might be expired, redirect to login
          console.error('JWT login error:', error);
      });
      ```
    </Accordion>
  </Tab>
</Tabs>

### Response Examples

<CardGroup cols={2}>
  <Card title="Successful Login" icon="check-circle" color="#16a34a">
    ```json
    {
        "success": true,
        "data": {
            "jwt_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
            "refresh_token": "abc123def456...",
            "user_id": 123,
            "user_email": "user@example.com",
            "user_display_name": "John Doe"
        }
    }
    ```
  </Card>

  <Card title="2FA Required" icon="shield-exclamation" color="#f59e0b">
    ```json
    {
        "code": "cocart_2fa_required",
        "message": "2FA verification required",
        "data": {
            "status": 400,
            "2fa_required": true,
            "available_providers": ["totp", "sms", "email"],
            "default_provider": "totp"
        }
    }
    ```
  </Card>

  <Card title="Invalid 2FA" icon="x-circle" color="#dc2626">
    ```json
    {
        "code": "cocart_2fa_invalid",
        "message": "Invalid 2FA code",
        "data": {
            "status": 401
        }
    }
    ```
  </Card>

  <Card title="Rate Limited" icon="clock" color="#6b7280">
    ```json
    {
        "code": "cocart_rate_limited",
        "message": "Too many login attempts. Please try again later.",
        "data": {
            "status": 429,
            "retry_after": 3600
        }
    }
    ```
  </Card>
</CardGroup>

## Authentication Flow

<Tabs>
  <Tab title="First-Time Login (Basic Auth + 2FA)">
    <Steps>
      <Step title="Initial Authentication">
        User provides username/password via Basic Auth
      </Step>
      <Step title="Basic Validation">
        Basic authentication succeeds → user authenticated
      </Step>
      <Step title="Permission Callback">
        Permission callback runs → detects `basic_auth` method
      </Step>
      <Step title="2FA Check">
        2FA filter executes → checks for 2FA requirements
      </Step>
      <Step title="2FA Prompt">
        If 2FA required → returns error with 2FA prompt
      </Step>
      <Step title="2FA Validation">
        User provides 2FA code → 2FA validates successfully
      </Step>
      <Step title="JWT Token Issued">
        Login response includes JWT token for future requests
      </Step>
    </Steps>
  </Tab>

  <Tab title="Subsequent Requests (JWT Token)">
    <Steps>
      <Step title="JWT Authentication">
        User provides JWT token via Bearer Authorization
      </Step>
      <Step title="JWT Validation">
        JWT authentication succeeds → user authenticated
      </Step>
      <Step title="Permission Check">
        Permission callback runs → detects `jwt` method
      </Step>
      <Step title="Skip Additional Checks">
        2FA filter SKIPPED → secure authentication method bypasses additional checks
      </Step>
      <Step title="Immediate Success">
        Login succeeds immediately → no 2FA prompt
      </Step>
    </Steps>
  </Tab>
</Tabs>

## Advanced Configuration

### Customizing Secure Authentication Methods

You can modify which authentication methods skip additional checks like 2FA:

```php
add_filter( 'cocart_login_secure_auth_methods', 'my_secure_auth_methods', 10, 2 );
function my_secure_auth_methods( $secure_methods, $current_method ) {
    // Add custom secure authentication methods
    $secure_methods[] = 'custom_oauth';

    // Remove JWT from secure methods (force 2FA even with JWT)
    $secure_methods = array_diff( $secure_methods, array( 'jwt' ) );

    return $secure_methods;
}
```

### Rate Limiting Implementation

Implement rate limiting to prevent brute force attacks:

```php
add_filter( 'cocart_login_permission_callback', 'implement_rate_limiting', 5, 4 );
function implement_rate_limiting( $permission, $current_user, $request, $endpoint ) {
    if ( true !== $permission ) {
        return $permission;
    }

    $ip_address = CoCart_Authentication::get_ip_address();
    $cache_key = 'cocart_login_attempts_' . md5( $ip_address );
    $attempts = get_transient( $cache_key ) ?: 0;

    if ( $attempts >= 5 ) {
        return new WP_Error(
            'cocart_rate_limited',
            'Too many login attempts. Please try again later.',
            array( 'status' => 429 )
        );
    }

    // Increment attempts counter
    set_transient( $cache_key, $attempts + 1, HOUR_IN_SECONDS );

    return $permission;
}

// Reset attempts on successful login
add_action( 'cocart_login_permission_granted', 'reset_login_attempts', 10, 3 );
function reset_login_attempts( $current_user, $request, $endpoint ) {
    $ip_address = CoCart_Authentication::get_ip_address();
    $cache_key = 'cocart_login_attempts_' . md5( $ip_address );
    delete_transient( $cache_key );
}
```

### Custom Authentication Provider

Create a custom authentication provider that integrates with external systems:

```php
add_filter( 'cocart_login_permission_callback', 'custom_ldap_auth', 10, 4 );
function custom_ldap_auth( $permission, $current_user, $request, $endpoint ) {
    if ( true !== $permission ) {
        return $permission;
    }

    // Check if LDAP authentication is required for this user
    $require_ldap = get_user_meta( $current_user->ID, 'require_ldap_auth', true );

    if ( $require_ldap ) {
        $ldap_token = $request->get_param( 'ldap_token' );

        if ( empty( $ldap_token ) ) {
            return new WP_Error(
                'cocart_ldap_required',
                'LDAP authentication required',
                array( 'status' => 400, 'ldap_required' => true )
            );
        }

        // Validate with LDAP server
        if ( ! validate_ldap_token( $current_user->user_login, $ldap_token ) ) {
            return new WP_Error(
                'cocart_ldap_invalid',
                'Invalid LDAP credentials',
                array( 'status' => 401 )
            );
        }
    }

    return $permission;
}
```

## Implementation Guidelines

1. **Always check the current permission status first** - If it's already an error, don't override it
2. **Respect secure authentication methods** - Use the `cocart_login_secure_auth_methods` filter appropriately
3. **Provide clear error messages** - Include helpful information in error responses
4. **Use appropriate HTTP status codes** - 400 for missing required data, 401 for invalid credentials
5. **Include metadata in error responses** - Help clients understand what's needed
6. **Implement rate limiting** - Protect against brute force attacks
7. **Log security events** - Use the permission granted action for audit trails
8. **Validate all inputs** - Sanitize and validate all request parameters
9. **Follow WordPress coding standards** - Maintain consistency with WordPress conventions

## Security Considerations

<Warning>
    Always implement proper security measures when extending authentication. These considerations are crucial for maintaining system security.
</Warning>

<AccordionGroup>
  <Accordion title="Input Validation" icon="shield-check">
    - **Validate all input parameters thoroughly** - Never trust user input
    - **Sanitize all data** - Use WordPress sanitization functions
    - **Validate parameter types** - Ensure data matches expected types
    - **Check parameter lengths** - Prevent buffer overflow attacks
  </Accordion>

  <Accordion title="Rate Limiting" icon="gauge-high">
    - **Implement rate limiting** - Prevent brute force attacks on authentication endpoints
    - **Use progressive delays** - Increase delay time with repeated failures
    - **Track by IP address** - Monitor attempts per IP address
    - **Consider geographic restrictions** - Block suspicious regions if needed
  </Accordion>

  <Accordion title="Token Security" icon="key">
    - **Use secure random generation** - For 2FA codes and tokens
    - **Consider time windows** - Implement expiration for codes and tokens
    - **Prevent replay attacks** - Use nonces or timestamps to prevent reuse
    - **Implement proper session management** - Handle JWT tokens securely
  </Accordion>

  <Accordion title="Data Protection" icon="lock">
    - **Use HTTPS in production** - Never transmit credentials over HTTP
    - **Store sensitive data securely** - Encrypt TOTP secrets and similar data
    - **Implement secure storage** - Use WordPress encrypted storage APIs
    - **Regular security audits** - Review authentication implementations regularly
  </Accordion>

  <Accordion title="Monitoring & Logging" icon="eye">
    - **Log authentication events** - Monitor for suspicious activity
    - **Track failed attempts** - Identify potential attacks
    - **Monitor unusual patterns** - Detect anomalous behavior
    - **Set up alerts** - Notify administrators of security events
  </Accordion>
</AccordionGroup>

## Testing Your Implementation

### Simple Test Filter

Test the authentication injection mechanism with a basic filter:

```php
// Simple test filter for development
add_filter( 'cocart_login_permission_callback', 'test_auth_injection', 10, 4 );
function test_auth_injection( $permission, $user, $request, $endpoint ) {
    if ( true !== $permission ) {
        return $permission;
    }

    $test_param = $request->get_param( 'test_auth' );
    if ( 'allow' !== $test_param ) {
        return new WP_Error(
            'test_auth_required',
            'Add test_auth=allow parameter for testing',
            array( 'status' => 400 )
        );
    }

    return true;
}
```

### Test with cURL

```bash
# This should fail
curl -X POST "https://yoursite.com/wp-json/cocart/v2/login" \
  -H "Authorization: Basic $(echo -n 'username:password' | base64)" \
  -H "Content-Type: application/json"

# This should succeed
curl -X POST "https://yoursite.com/wp-json/cocart/v2/login" \
  -H "Authorization: Basic $(echo -n 'username:password' | base64)" \
  -H "Content-Type: application/json" \
  -d '{"test_auth": "allow"}'
```

### Integration Testing

1. **Test different authentication methods** - Basic Auth, JWT, API Keys
2. **Verify error responses** - Check status codes and error messages
3. **Test rate limiting** - Ensure brute force protection works
4. **Verify logging** - Check that authentication events are logged
5. **Test edge cases** - Invalid tokens, expired codes, malformed requests

## Common Use Cases

<CardGroup cols={2}>
  <Card title="Single Sign-On (SSO)" icon="link" href="#sso-integration">
    Integrate with external SSO providers like SAML, OAuth, or LDAP
  </Card>
  <Card title="Role-Based Auth" icon="users" href="#role-based-authentication">
    Add extra verification for specific user roles or capabilities
  </Card>
  <Card title="Device Registration" icon="mobile" href="#device-registration">
    Require device registration for enhanced security
  </Card>
  <Card title="Geolocation Blocking" icon="globe" href="#geolocation-blocking">
    Restrict access based on geographic location
  </Card>
</CardGroup>

<AccordionGroup>
  <Accordion title="SSO Integration" icon="link">
    ```php
    add_filter( 'cocart_login_permission_callback', 'sso_integration', 10, 4 );
    function sso_integration( $permission, $current_user, $request, $endpoint ) {
        if ( true !== $permission ) {
            return $permission;
        }

        $sso_token = $request->get_param( 'sso_token' );
        if ( ! empty( $sso_token ) ) {
            // Validate SSO token with external provider
            $sso_valid = validate_sso_token( $sso_token, $current_user->user_email );

            if ( ! $sso_valid ) {
                return new WP_Error(
                    'cocart_sso_invalid',
                    'Invalid SSO token',
                    array( 'status' => 401 )
                );
            }
        }

        return $permission;
    }
    ```
  </Accordion>

  <Accordion title="Role-Based Authentication" icon="users">
    ```php
    add_filter( 'cocart_login_permission_callback', 'role_based_auth', 10, 4 );
    function role_based_auth( $permission, $current_user, $request, $endpoint ) {
        if ( true !== $permission ) {
            return $permission;
        }

        // Require additional verification for admin users
        if ( in_array( 'administrator', $current_user->roles ) ) {
            $admin_code = $request->get_param( 'admin_verification_code' );

            if ( empty( $admin_code ) ) {
                return new WP_Error(
                    'cocart_admin_verification_required',
                    'Additional verification required for admin users',
                    array( 'status' => 400, 'admin_verification_required' => true )
                );
            }

            if ( ! verify_admin_code( $current_user->ID, $admin_code ) ) {
                return new WP_Error(
                    'cocart_admin_verification_invalid',
                    'Invalid admin verification code',
                    array( 'status' => 401 )
                );
            }
        }

        return $permission;
    }
    ```
  </Accordion>

  <Accordion title="Device Registration" icon="mobile">
    ```php
    add_filter( 'cocart_login_permission_callback', 'device_registration_check', 10, 4 );
    function device_registration_check( $permission, $current_user, $request, $endpoint ) {
        if ( true !== $permission ) {
            return $permission;
        }

        $device_id = $request->get_param( 'device_id' );
        $user_agent = $request->get_header( 'user_agent' );

        if ( empty( $device_id ) ) {
            return new WP_Error(
                'cocart_device_id_required',
                'Device ID is required for authentication',
                array( 'status' => 400 )
            );
        }

        // Check if device is registered for this user
        $registered_devices = get_user_meta( $current_user->ID, 'registered_devices', true ) ?: array();

        if ( ! in_array( $device_id, $registered_devices ) ) {
            return new WP_Error(
                'cocart_device_not_registered',
                'This device is not registered for this account',
                array( 'status' => 403, 'device_registration_required' => true )
            );
        }

        return $permission;
    }
    ```
  </Accordion>

  <Accordion title="Geolocation Blocking" icon="globe">
    ```php
    add_filter( 'cocart_login_permission_callback', 'geolocation_check', 10, 4 );
    function geolocation_check( $permission, $current_user, $request, $endpoint ) {
        if ( true !== $permission ) {
            return $permission;
        }

        $ip_address = CoCart_Authentication::get_ip_address();
        $country_code = get_country_from_ip( $ip_address );

        // Block certain countries
        $blocked_countries = array( 'XX', 'YY', 'ZZ' );

        if ( in_array( $country_code, $blocked_countries ) ) {
            return new WP_Error(
                'cocart_geo_blocked',
                'Access from your location is not permitted',
                array( 'status' => 403, 'country_code' => $country_code )
            );
        }

        return $permission;
    }
    ```
  </Accordion>
</AccordionGroup>

<Note>
All authentication extensions follow WordPress coding standards and integrate seamlessly with CoCart's existing authentication system. The examples above demonstrate practical implementations for common security requirements.
</Note>